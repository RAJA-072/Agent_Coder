
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agentic Repo QA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a32cc;
      --glass: rgba(255,255,255,0.06);
      --text:#ecf2ff;
      --muted:#9fb3ff;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial,sans-serif;
      color:var(--text);
      background: linear-gradient(145deg,#090e1b,#141b33 55%, #0d1327);
      min-height:100vh;
    }
    .page{display:flex;flex-direction:column;min-height:100vh}
    .header, .footer{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 24px;
    }
    .header.glass, .footer.glass, .card.glass{background:var(--glass); border:1px solid #223061; border-radius:12px}
    .logo{
      font-weight:400;
      font-size:16px;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      letter-spacing: 0.5px;
      opacity: 0.85;
    }
    .pill{padding:8px 12px; border-radius:999px; background:#1b2549; color:var(--text); text-decoration:none; border:1px solid #2a3a6d}
    .content{max-width:1100px; margin:40px auto; padding:0 16px; display:flex; flex-direction:column; gap:20px}
    .card{border-radius:16px; padding:18px}
    .card h1, .card h2{
      margin:0 0 12px 0;
      font-weight:400;
      font-size:1.25rem;
      letter-spacing:0.2px;
      opacity:0.92;
    }
    .card h1{
      font-size:1.25rem;
      font-weight:400;
      letter-spacing:0.3px;
      opacity:0.95;
    }
    .grid{display:grid; grid-template-columns:1.6fr 1fr auto; gap:10px}
    .grid input, .chat-input input{
      background:#0e1630; border:1px solid #243367; padding:12px; border-radius:12px; color:var(--text);
    }
    .grid button, .chat-input button{
      background:linear-gradient(135deg,#6f8dff,#7aa2ff);
      color:#0a1130; border:none; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer;
      box-shadow: 0 6px 22px rgba(122,162,255,0.3);
    }
    .grid button:hover, .chat-input button:hover{filter:brightness(1.05)}
    .status{margin-top:10px; font-size:14px; color:var(--muted)}
    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:20px}
    .meta{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .meta div{background:#0e1630; border:1px solid #1e2a52; padding:10px; border-radius:10px}
    .meta div b{
      display:block;
      color:var(--muted);
      font-size:11px;
      margin-bottom:4px;
      font-weight:400;
      letter-spacing:0.1px;
      opacity:0.8;
    }
    .files{max-height:300px; overflow:auto; border:1px solid #1e2a52; border-radius:12px; padding:10px; background:#0e1630}
    .file{padding:6px 8px; border-bottom:1px dashed #1e2a52; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}
    .file:last-child{border-bottom:none}
    .chat{display:flex; flex-direction:column; gap:12px}
    .chat-log{border:1px solid #1e2a52; border-radius:12px; background:#0e1630; padding:12px; height:320px; overflow:auto}
    .msg{display:flex; gap:10px; margin-bottom:10px}
    .msg .bubble{padding:10px 12px; border-radius:12px; max-width:78%}
    .msg.user .bubble{margin-left:auto; background:#203062; border:1px solid #2a3a6d}
    .msg.bot .bubble{background:#0f1a3c; border:1px solid #2a3a6d}
    .msg .who{font-size:12px; color:var(--muted); margin-bottom:4px}
    .footer{color:#9fb3ff; padding:12px 24px}
    @media (max-width:900px){
      .two-col{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr;}
    }
  </style>
  <script src="{{ url_for('static', filename='script.js') }}"></script>

</head>
<body>
  <canvas id="space-bg" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;"></canvas>
  <script>
    // Space background animation
    const canvas = document.getElementById('space-bg');
    const ctx = canvas.getContext('2d');
    let w = window.innerWidth, h = window.innerHeight;
    function resize() {
      w = window.innerWidth; h = window.innerHeight;
      canvas.width = w; canvas.height = h;
    }
    window.addEventListener('resize', resize);
    resize();

    // Light particles (stars)
    const particles = Array.from({length: 120}, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 1.2 + 0.3,
      s: Math.random() * 0.4 + 0.1,
      o: Math.random() * 0.5 + 0.5
    }));

    // Meteors
    function randomMeteor() {
      const angle = Math.PI / 3 + Math.random() * 0.2;
      return {
        x: Math.random() * w,
        y: -40,
        len: 80 + Math.random() * 60,
        speed: 8 + Math.random() * 4,
        angle,
        alpha: 0.7 + Math.random() * 0.3,
        width: 2 + Math.random() * 1.5
      };
    }
    let meteors = [];

    function draw() {
      ctx.clearRect(0, 0, w, h);

      // Draw particles
      for (const p of particles) {
        ctx.save();
        ctx.globalAlpha = p.o + Math.sin(Date.now()/700 + p.x)*0.2;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = "#b6cfff";
        ctx.shadowColor = "#b6cfff";
        ctx.shadowBlur = 8;
        ctx.fill();
        ctx.restore();

        // Move slowly
        p.x += p.s * 0.2;
        if (p.x > w) p.x = 0;
      }

      // Draw meteors
      for (let i = meteors.length - 1; i >= 0; i--) {
        const m = meteors[i];
        ctx.save();
        ctx.globalAlpha = m.alpha;
        ctx.strokeStyle = "rgba(122,162,255,0.8)";
        ctx.shadowColor = "#7aa2ff";
        ctx.shadowBlur = 16;
        ctx.lineWidth = m.width;
        ctx.beginPath();
        ctx.moveTo(m.x, m.y);
        ctx.lineTo(
          m.x - Math.cos(m.angle) * m.len,
          m.y - Math.sin(m.angle) * m.len
        );
        ctx.stroke();
        ctx.restore();

        // Move meteor
        m.x += Math.cos(m.angle) * m.speed;
        m.y += Math.sin(m.angle) * m.speed;
        m.alpha -= 0.008;
        if (m.y > h + 60 || m.alpha <= 0) meteors.splice(i, 1);
      }

      // Occasionally add a meteor (rare, max 2 meteors)
      if (Math.random() < 0.004 && meteors.length < 2) {
        meteors.push(randomMeteor());
      }

      requestAnimationFrame(draw);
    }
    draw();
  </script>
  <div class="page" style="position:relative;z-index:1;">
    <header class="header glass">
      <div class="logo">ðŸ¤– Agentic Repo QA</div>
      <div class="right">
        <a class="pill" href="https://github.com" target="_blank" rel="noreferrer">GitHub</a>
      </div>
    </header>

    <main class="content">
      <section class="card glass">
        <h1>Load a GitHub repository</h1>
        <div class="grid">
          <input id="repo-url" type="url" placeholder="https://github.com/owner/repo" />
          <select id="persona" style="padding:12px; border-radius:12px; border:1px solid #243367; background:#0e1630; color:var(--text);">
            <option value="student (beginner)">Student (Beginner)</option>
            <option value="student (intermediate)">Student (Intermediate)</option>
            <option value="student (advanced)">Student (Advanced)</option>
          </select>
          <button id="load-btn">Load Repo</button>
        </div>
        <div id="load-status" class="status">Enter a repo URL above and click Load Repo</div>
      </section>

      <section class="two-col">
        <div class="card glass">
          <h2>Repository</h2>
          <div id="meta" class="meta"></div>
        </div>
        <div class="card glass">
          <h2>Files (preview)</h2>
          <div id="files" class="files"></div>
        </div>
      </section>

      <!-- NEW SUMMARY BOX -->
      <section class="card glass">
        <h2>Role-based Summary</h2>
        <div id="summary-box" class="files" style="min-height:120px; white-space:pre-wrap"></div>
      </section>

      <section class="chat card glass">
        <h2>Ask about this repo</h2>
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
          <input id="question" type="text" placeholder="What does the training script do?" />
          <button id="ask-btn">Ask</button>
        </div>
      </section>
    </main>

    <footer class="footer glass">
      <div>Built with Flask â€¢ GitPython â€¢ Gemini</div>
    </footer>
  </div>

  <script>
    const metaEl = document.getElementById("meta");
    const filesEl = document.getElementById("files");
    const statusEl = document.getElementById("load-status");
    const chatLog = document.getElementById("chat-log");

    function renderMeta(meta){
      metaEl.innerHTML = "";
      const keys = ["Name","Full Name","Description","Stars","Forks","Open Issues","Language","License","URL"];
      keys.forEach(k => {
        const v = meta[k] ?? "";
        const div = document.createElement("div");
        div.innerHTML = `<b>${k}</b>${v}`;
        metaEl.appendChild(div);
      });
    }

    function renderFiles(list){
      filesEl.innerHTML = "";
      if (!list || !list.length){
        filesEl.textContent = "No files found.";
        return;
      }
      list.forEach(p => {
        const d = document.createElement("div");
        d.className = "file";
        d.textContent = p;
        filesEl.appendChild(d);
      });
    }

    async function loadRepoAndSummary(){
      const repoUrl = document.getElementById("repo-url").value.trim();
      const persona = document.getElementById("persona").value.trim() || "senior developer";
      if (!repoUrl){ statusEl.textContent = "Please enter a GitHub repository URL."; return; }
      statusEl.textContent = "Loading repositoryâ€¦";
      // Load Repo
      try{
        const resp = await fetch("/load_repo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ repo_url: repoUrl, persona })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Failed");
        statusEl.textContent = "Repository loaded âœ…";
        renderMeta(data.metadata || {});
        renderFiles(data.files || []);
        pushBot("Repository loaded. Ask anything about it!");
      }catch(e){
        statusEl.textContent = "Error: " + e.message;
        pushBot("Failed to load repository. " + e.message);
      }
      // Generate Summary
      document.getElementById("summary-box").textContent = "Generating summaryâ€¦";
      try{
        const formData = new FormData();
        formData.append("role", persona);
        formData.append("repo_link", repoUrl);
        const resp = await fetch("/process_repo", {
          method: "POST",
          body: formData
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data.error || "Failed");
        document.getElementById("summary-box").innerHTML = marked.parse(data.summary || "");
      }catch(e){
        document.getElementById("summary-box").textContent = "Error: " + e.message;
      }
    }

    function pushUser(text){
      const node = document.createElement("div");
      node.className = "msg user";
      node.innerHTML = `<div class="bubble"><div class="who">You</div>${escapeHtml(text)}</div>`;
      chatLog.appendChild(node);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function pushBot(text){
      const node = document.createElement("div");
  node.className = "msg bot";
  node.innerHTML = `<div class="bubble"><div class="who">Bot</div><div class="md">${marked.parse(text || "")}</div></div>`;
  chatLog.appendChild(node);
  chatLog.scrollTop = chatLog.scrollHeight;
  // Optional: style markdown in chat
  const style = document.createElement('style');
  style.innerHTML = `.md h1,.md h2,.md h3{font-size:1em;margin:0.5em 0;} .md pre{background:#101a2c;padding:8px;border-radius:8px;overflow:auto;} .md code{background:#101a2c;padding:2px 4px;border-radius:4px;} .md ul{margin:0 0 0 1.2em;} .md li{margin-bottom:0.2em;}`;
  document.head.appendChild(style);
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<"'>]/g, function(m) {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          default: return '&#039;';
        }
      });
    }

    async function ask(){
      const q = document.getElementById("question").value.trim();
      if (!q) return;
      pushUser(q);
      document.getElementById("question").value = "";
      try{
        const resp = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q, persona: document.getElementById("persona").value || "senior developer" })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Failed");
        pushBot(data.answer || "(no answer)");
      }catch(e){
        pushBot("Error: " + e.message);
      }
    }

    document.getElementById("load-btn").addEventListener("click", loadRepo);
  document.getElementById("load-btn").addEventListener("click", loadRepoAndSummary);
  document.getElementById("ask-btn").addEventListener("click", ask);
  document.getElementById("question").addEventListener("keydown", (e)=>{ if(e.key==="Enter") ask(); });
  </script>
</body>
</html>
